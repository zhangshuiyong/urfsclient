<script setup lang="ts">
import { h,ref,reactive } from "vue";
import { invoke } from "@tauri-apps/api/tauri";
import { open } from '@tauri-apps/api/dialog';
import { info,error } from "tauri-plugin-log-api";
import { message } from 'ant-design-vue';
import { FileOutlined,FolderOutlined } from '@ant-design/icons-vue';

const uploadItemList:any = reactive([]);

async function select_upload_fold() {

    const selected_folder = await open({
        multiple: false,
        directory: true,
    });

    if(typeof selected_folder === 'string'){
        info("[ui] select upload folder :"+selected_folder);
        uploadItemList.push({name:selected_folder,isDir:true});
    }
}

async function star_upload(source:string) {

    info(`[ui] star_upload source path:${source}`);

    try{
       var resp = await invoke("start_upload", { req :JSON.stringify({
            dataset_id: 'xxx',
            dataset_version_id: source.substring(source.lastIndexOf('/')+1),
            dataset_source: source,
            server_endpoint: 'http://0.0.0.0:65004'
        })});

        message.success('上传请求已发送');

        info(`上传请求返回: ${resp}`);

    }catch(err: any){
        message.error('上传出错：',err);
        error(`上传出错: ${err}`);
    }
}

async function stop_upload() {
    try{
      var resp = await invoke("stop_upload", { req :JSON.stringify({
            dataset_id: 'xxx',
            dataset_version_id: 'default',
        })})
        message.success("暂停上传请求已发送");

        info(`暂停上传请求返回: ${resp}`);

    }catch(err: any){
        message.error("暂停上传出错：", err);
        error(`暂停上传出错: ${err}`);
    }
}

async function terminate_upload() {
    try{
       var resp = await invoke("terminate_upload", { req :JSON.stringify({
            dataset_id: 'xxx',
            dataset_version_id: 'default',
          })})
        message.success("终止上传已发送");

        info(`终止上传请求返回: ${resp}`);

    }catch(err: any){
        message.error("终止上传出错：", err);
        error(`终止上传出错: ${err}`);
    }
}

async function get_history() {
    try{
        info("[ui] click get_history btn")
        let history = await invoke("get_history", {req: JSON.stringify({ req: "{}" })})
        message.success("获取文件上传历史成功");
        info("[ui] get_history result:"+history);
    }catch(err: any){
        message.error("获取文件上传历史错误：", err);
        error(`获取文件上传历史出错: ${err}`);
    }
}

</script>

<template>
  <div class="card">
    <button type="button" @click="select_upload_fold()">上传数据集</button>
    <button type="button" @click="get_history()">历史任务</button>
  </div>

  <a-list
    class="demo-upload-list"
    item-layout="horizontal"
    :data-source="uploadItemList"
  >
    
    <template #renderItem="{ item }">
      <a-list-item>
        <template #actions>
          <a key="star_upload" @click="star_upload(item.name)">开始上传</a>
          <a key="stop_upload" @click="stop_upload()">暂停上传</a>
          <a key="terminate_upload" @click="terminate_upload()">终止上传</a>
        </template>
       <div>
          <a-list-item-meta description="">
            <template #title>
              <span>{{ item.name }}</span>
            </template>
            <template #avatar>
                <a-avatar size="small" v-if="item.isDir===false">
                    <template #icon><FileOutlined /></template>
                </a-avatar>
                <a-avatar size="small" v-if="item.isDir===true">
                    <template #icon><FolderOutlined /></template>
                </a-avatar>
            </template>
          </a-list-item-meta>
        </div>
      </a-list-item>
    </template>
  </a-list>
</template>
